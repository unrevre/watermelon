#!/usr/bin/env python
# pylint: disable=missing-docstring,invalid-name

import re
import textwrap

BITS = 128

FILES = 9
RANKS = 10
SENTINEL = 1

WIDTH = FILES + 2 * SENTINEL
HEIGHT = RANKS
POINTS = WIDTH * HEIGHT

class Mask():
    def __init__(self):
        self.bits = bytearray(128)

    def __str__(self):
        strrep = ''.join((str(b) for b in self.bits[::-1]))
        hexrep = (hex(int(strrep[:64], 2)), hex(int(strrep[64:], 2)))
        return '(((__uint128_t){}) << 64) + {}'.format(hexrep[0], hexrep[1])

    def clear(self):
        self.bits = bytearray(128)

    def index(self, x, y):
        return y * WIDTH + x

    def fill(self, index, count, value):
        for i in range(count):
            self.bits[index + i] = value


class Board(Mask):
    def __init__(self):
        super().__init__()

    def index(self, x, y):
        return y * WIDTH + SENTINEL + x

    def layout_board(self):
        for y in range(HEIGHT):
            self.fill(self.index(0, y), FILES, 1)

    def layout_jmask(self, side):
        h = HEIGHT - 3 if side else 0
        for y in range(h, h + 3):
            self.fill(self.index(3, y), 3, 1)

    def layout_smask(self, side):
        h = HEIGHT - 3 if side else 0
        for x, y in ((3, h), (5, h), (4, h + 1), (3, h + 2), (5, h + 2)):
            self.fill(self.index(x, y), 1, 1)

    def layout_xmask(self, side):
        h = HEIGHT - 5 if side else 0
        for x, y in ((2, h), (6, h), (0, h + 2), (4, h + 2), (8, h + 2),
                     (2, h + 4), (6, h + 4)):
            self.fill(self.index(x, y), 1, 1)

    def layout_zmask(self, side):
        h = HEIGHT - 5 if side else 3
        for y in range(h, h + 2):
            for x, y in ((0, y), (2, y), (4, y), (6, y), (8, y)):
                self.fill(self.index(x, y), 1, 1)

        h = 0 if side else HEIGHT - 5
        for y in range(h, h + 5):
            self.fill(self.index(0, y), FILES, 1)


def main():
    mask = Mask()
    board = Board()

    # templates
    typename = 'const __uint128_t'
    attr_align = '__attribute__((aligned(64)))'

    class clear_and_return():
        def __init__(self, mask):
            self.mask = mask

        def __call__(self, fn):
            def wrapped(*args):
                self.mask.clear()
                fn(*args)
                return self.mask
            return wrapped

    class format():
        def __call__(self, fn):
            def wrapped(identifier):
                f.write(identifier + ' =\n   ' + fn().__str__() + ';\n\n')
            return wrapped

    class array_format():
        def __init__(self, n):
            self.n = n

        def __call__(self, fn):
            def wrapped(identifier):
                f.write(identifier + ' = {\n')
                for i in range(self.n):
                    f.write('   ' + fn(i).__str__() + ',\n')
                f.truncate(f.tell() - 2)
                f.write('\n};\n\n')
            return wrapped

    # generate source (.c) file
    output = 'masks.c'

    with open(output, 'a') as f:
        f.write(textwrap.dedent(
            """
            /* auto-generated by maskgen.py */
            #include "masks.h"

            """))

        # board mask    [BMASK]
        @format()
        @clear_and_return(board)
        def etch_board_mask():
            board.layout_board()

        etch_board_mask('{} BMASK'.format(typename))

        # point masks   [PMASK]
        @array_format(BITS)
        @clear_and_return(mask)
        def etch_point_masks(i):
            mask.fill(i, 1, 1)

        etch_point_masks('{} PMASK[BITS] {}'.format(typename, attr_align))

        # upper masks   [UMASK]
        @array_format(POINTS)
        @clear_and_return(mask)
        def etch_upper_masks(i):
            mask.fill(i + 1, BITS - 1 - i, 1)

        etch_upper_masks('{} UMASK[POINTS] {}'.format(typename, attr_align))

        # lower masks   [LMASK]
        @array_format(POINTS)
        @clear_and_return(mask)
        def etch_lower_masks(i):
            mask.fill(0, i, 1)

        etch_lower_masks('{} LMASK[POINTS] {}'.format(typename, attr_align))

        # rank masks    [RMASK]
        @array_format(POINTS)
        @clear_and_return(mask)
        def etch_rank_masks(i):
            mask.fill(mask.index(SENTINEL, i // WIDTH), FILES, 1)

        etch_rank_masks('{} RMASK[POINTS] {}'.format(typename, attr_align))

        # file masks    [FMASK]
        @array_format(POINTS)
        @clear_and_return(mask)
        def etch_file_masks(i):
            for y in range(RANKS):
                mask.fill(mask.index(i % WIDTH, y), 1, 1)

        etch_file_masks('{} FMASK[POINTS] {}'.format(typename, attr_align))

        # outer masks   [OMASK]
        @array_format(POINTS)
        @clear_and_return(mask)
        def etch_outer_masks(i):
            for x, y in ((0, i // WIDTH), (WIDTH - 1, i // WIDTH),
                         (i % WIDTH, 0), (i % WIDTH, HEIGHT - 1)):
                mask.fill(mask.index(x, y), 1, 1)
            mask.fill(i, 1, 0)

        etch_outer_masks('{} OMASK[POINTS] {}'.format(typename, attr_align))

        # jiang mask    [JMASK]
        @array_format(2)
        @clear_and_return(board)
        def etch_jmasks(i):
            board.layout_jmask(i)

        etch_jmasks('{} JMASK[2]'.format(typename))

        # shi mask      [SMASK]
        @array_format(2)
        @clear_and_return(board)
        def etch_smasks(i):
            board.layout_smask(i)

        etch_smasks('{} SMASK[2]'.format(typename))

        # xiang mask    [XMASK]
        @array_format(2)
        @clear_and_return(board)
        def etch_xmasks(i):
            board.layout_xmask(i)

        etch_xmasks('{} XMASK[2]'.format(typename))

        # zu mask       [ZMASK]
        @array_format(2)
        @clear_and_return(board)
        def etch_zmasks(i):
            board.layout_zmask(i)

        etch_zmasks('{} ZMASK[2]'.format(typename))

    # generate header (.h) file
    output = re.sub(r'.c$', '.h', output)

    with open(output, 'a') as f:
        f.write(textwrap.dedent(
            """
            /* auto-generated by maskgen.py */
            #ifndef MASKS_H
            #define MASKS_H

            #include "magics.h"

            extern {0} BMASK;

            extern {0} PMASK[BITS];

            extern {0} UMASK[POINTS];
            extern {0} LMASK[POINTS];
            extern {0} RMASK[POINTS];
            extern {0} FMASK[POINTS];
            extern {0} OMASK[POINTS];

            extern {0} JMASK[2];
            extern {0} SMASK[2];
            extern {0} XMASK[2];
            extern {0} ZMASK[2];

            #endif /* MASKS_H */
            """.format(typename)))

if __name__ == '__main__':
    main()
